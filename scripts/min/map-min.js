function navBar(){selectedMarker<=1?($(".map-nav-control a[rel=next]").removeClass("is-hidden"),$(".stop-counter").removeClass("is-hidden"),$(".map-nav-control a[rel=prev]").addClass("is-hidden"),$(".map-nav-control a[rel=begin]").addClass("is-hidden"),$(".map-nav-control a[rel=startover]").addClass("is-hidden")):selectedMarker===markers.length?($(".map-nav-control a[rel=startover]").removeClass("is-hidden"),$(".map-nav-control a[rel=prev]").removeClass("is-hidden"),$(".map-nav-control a[rel=begin]").addClass("is-hidden"),$(".map-nav-control a[rel=next]").addClass("is-hidden")):($(".map-nav-control a[rel=prev]").removeClass("is-hidden"),$(".map-nav-control a[rel=next]").removeClass("is-hidden"),$(".stop-counter").removeClass("is-hidden"),$(".map-nav-control a[rel=startover]").addClass("is-hidden"),$(".map-nav-control a[rel=begin]").addClass("is-hidden")),$(".location:nth-child("+selectedMarker+")").addClass("is-current").siblings().removeClass("is-current"),scrollSidebar.scrollToElement(document.querySelector(".location:nth-child("+selectedMarker+")"),600,null,!0),$("#stop-number").text(selectedMarker),$("#toggle2").is(":checked")&&$("#toggle2").click()}function next(){var e;0===selectedMarker?(e=selectedMarker-1,++e):selectedMarker===markers.length?(e=0,map.setView(markers[e].getLatLng(),8)):(e=selectedMarker-1,++e,map.setView(markers[e].getLatLng(),8)),markers[e].openPopup(),selectedMarker=e+1,navBar()}function prev(){var e=selectedMarker-1;--e,map.setView(markers[e].getLatLng(),8),markers[e].openPopup(),selectedMarker=e+1,navBar()}function galleryName(e,a){$(".gallery-header .gallery-stop-number").text(e),$(".gallery-header .gallery-stop-name").text(a)}function createGallery(e,a){var r=document.getElementById("stop-gallery"),t=a-1,i=featureLayer._geojson.features[t].properties.title;$.each(e,function(e,i){$("#stop-gallery li").remove(),$.each(i.stops[t].galleryImages,function(e,t){item=r.appendChild(document.createElement("li")),item.innerHTML='<a href="images/'+tripData+"/stop"+a+"/stop"+a+"_"+t.imageID+'.jpg" class="gallery-link" data-caption="'+t.imageCaption+'"><img src="images/'+tripData+"/stop"+a+"/stop"+a+"_"+t.imageID+'.jpg"></a>'})}),galleryName(a,i),$(".gallery-close").removeClass("is-hidden")}function mapIt(){featureLayer=L.mapbox.featureLayer().loadURL("data/"+tripData+".geojson").addTo(map),locationList=document.getElementById("location-list"),featureLayer.on("ready",function(){map.fitBounds(featureLayer.getBounds()),tripName=featureLayer._geojson.tripName,tripType=featureLayer._geojson.tripType,tripStartDate=featureLayer._geojson.tripStartDate,tripEndDate=featureLayer._geojson.tripEndDate,$(".trip-name").text(tripName),$(".trip-start-date").text(tripStartDate),$(".trip-end-date").text(tripEndDate),$(".app-header").removeClass().addClass("app-header banner-"+tripType),$(".sidebar-header").addClass("sidebar-"+tripType),featureLayer.eachLayer(function(e){var a=locationList.appendChild(document.createElement("li")),r=e.feature.properties.date,t=e.feature.properties.title,i=e.feature.properties.id,l=e.feature.properties.image,s=e.feature.properties.city,n=e.feature.properties.street,o=e.feature.properties.description,d=e.feature.properties.place,c=e.feature.properties.gallery,p,m;m=c===!0?'<a class="gallery-link" data-stop-id="'+i+'"><svg class="icon"><use xlink:href="#icon-image"></use></svg> View gallery</a>':'<a class="is-hidden"></a>',p=l===!0?'<header class="info-popup-header with-image" style="background-image: url(images/'+tripData+"/background"+i+'.jpg)"></header>':'<header class="banner-'+tripType+' info-popup-header"></header>',$(a).addClass("location"),e.bindPopup(p+'<div class="info-popup-header-content"><div class="location-date"><span class="location-id">Stop #'+i+"</span>"+r+'</div><h1 class="location-title">'+t+'</h1></div><div class="location-address"><div>'+n+"</div><div>"+s+'</div></div><div class="location-description">'+o+"</div>"+m),a.innerHTML='<div class="location-date"><span class="location-id">Stop #'+i+"</span>"+r+'</div><div class="location-name"><a>'+t+'</a></div><div class="location-place">'+d+"</div>"+m,a.onclick=function(){map.setView(e.getLatLng(),8),e.openPopup(),$(".menu-button").click(),selectedMarker=i,navBar()},$(a).on("click",".gallery-link",function(){$("#toggle2").click(),createGallery(galleryImages,i)}),e.on("click",function(){selectedMarker=i,navBar()}),markers=[],featureLayer.eachLayer(function(e){markers.push(e)})}),scrollSidebar.refresh()})}function imageNav(e,a,r){$(".image-viewer .focal-image").attr("src",a),$(".image-viewer .image-caption").text(r),$(".image-current").text(e),scrollGallerySidebar.refresh(),scrollGallerySidebar.scrollToElement(document.querySelector(".sidebar-gallery-list li.is-selected"),600,null,!0)}var map,locationList,featureLayer,markers,selectedMarker=0,tripName,tripType,tripStartDate,tripEndDate,galleryImages,stopNumber,tripData=window.location.hash;tripData=""===tripData?"co-trip":tripData.substr(1),L.mapbox.accessToken="pk.eyJ1IjoienN0ZWluZXIiLCJhIjoiTXR4U0tyayJ9.6BxBAjPyMHbt1YfD5HWGXA",map=L.mapbox.map("map-canvas","mapbox.outdoors"),$.getJSON("data/"+tripData+"-gallery.js").done(function(e){galleryImages=e}),mapIt(),$(".map-nav-control a[rel=begin], .map-nav-control a[rel=next], .map-nav-control a[rel=startover]").click(function(){next()}),$(".map-nav-control a[rel=prev]").click(function(){prev()}),$("#map-canvas").on("click",".gallery-link",function(){stopNumber=$(this).data("stop-id"),$("#toggle2").click(),createGallery(galleryImages,stopNumber)}),$(".sidebar-gallery-list").on("click",".gallery-link",function(e){var a=$(this).parent().index(),r=$(".sidebar-gallery-list li:last-child").index(),t=$(this).attr("href"),i=$(this).data("caption"),l=$(this).parent();r=++r,a=++a,e.preventDefault(),l.addClass("is-selected").siblings().removeClass("is-selected"),$(".gallery-close").addClass("is-hidden"),$(".image-viewer-container").removeClass("is-hidden"),$(".image-total").text(r),imageNav(a,t,i)}),$('.image-nav a[rel="prev"]').click(function(){var e,a,r,t;e=$(".sidebar-gallery-list .is-selected").is(":first-child")?$(".sidebar-gallery-list li:last-child"):$(".sidebar-gallery-list .is-selected").prev("li"),a=$(e).index()+1,r=$(e).children("a").attr("href"),t=$(e).children("a").data("caption"),$(e).addClass("is-selected").siblings().removeClass("is-selected"),imageNav(a,r,t)}),$('.image-nav a[rel="next"]').click(function(){var e,a,r,t;e=$(".sidebar-gallery-list .is-selected").is(":last-child")?$(".sidebar-gallery-list li:first-child"):$(".sidebar-gallery-list .is-selected").next("li"),a=$(e).index()+1,r=$(e).children("a").attr("href"),t=$(e).children("a").data("caption"),$(e).addClass("is-selected").siblings().removeClass("is-selected"),imageNav(a,r,t)}),$(".gallery-close, .image-viewer-close").click(function(){$(".image-viewer-container").addClass("is-hidden")}),$(".image-viewer-close").click(function(){$("#toggle2").click()}),scrollGallerySidebar.on("scrollStart",function(){scrollGallerySidebar.refresh()});